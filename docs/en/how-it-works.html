<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>How esy works · esy</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## Build Steps"/><meta property="og:title" content="How esy works · esy"/><meta property="og:type" content="website"/><meta property="og:url" content="https://esy.github.io/index.html"/><meta property="og:description" content="## Build Steps"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/reason-react-red.svg"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/arduino-light.min.css"/><link rel="stylesheet" href="/css/main.css"/></head><body class="sideNavVisible doc separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/en"><img class="logo" src="/img/block-white.svg" alt="esy"/><h2 class="headerTitleWithLogo">esy</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/en/what-why.html" target="_self">Docs</a></li><li class=""><a href="/docs/en/community.html" target="_self">Community</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg"/>English</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/fr/how-it-works.html">Français</a></li><li><a href="/docs/ru/how-it-works.html">Русский</a></li><li><a href="/docs/zh-CN/how-it-works.html">中文</a></li><li><a href="https://crowdin.com/project/esy-website" target="_blank" rel="noreferrer noopener">Help Translate</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(){
          if(languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><li class=""><a href="https://github.com/esy/esy" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>Internals</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup navGroupActive"><h3>Workflow</h3><ul><li class="navListItem"><a class="navItem" href="/docs/en/what-why.html">What &amp; Why</a></li><li class="navListItem"><a class="navItem" href="/docs/en/getting-started.html">Getting started</a></li><li class="navListItem"><a class="navItem" href="/docs/en/configuration.html">Project Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/en/esy-configuration.html">Configuration</a></li><li class="navListItem"><a class="navItem" href="/docs/en/environment.html">Environment</a></li><li class="navListItem"><a class="navItem" href="/docs/en/commands.html">Commands</a></li><li class="navListItem"><a class="navItem" href="/docs/en/concepts.html">Concepts</a></li></ul></div><div class="navGroup navGroupActive"><h3>Advanced</h3><ul><li class="navListItem"><a class="navItem" href="/docs/en/release.html">Building Releases</a></li></ul></div><div class="navGroup navGroupActive"><h3>Internals</h3><ul><li class="navListItem navListItemActive"><a class="navItem navItemActive" href="/docs/en/how-it-works.html">How esy works</a></li><li class="navListItem"><a class="navItem" href="/docs/en/development.html">Development</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://github.com/esy/esy/tree/master/docs/how-it-works.md" target="_blank" rel="noreferrer noopener">Edit</a><h1>How esy works</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="build-steps"></a><a href="#build-steps" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Build Steps</h2>
<p>The <code>build</code> entry in the <code>esy</code> config object is an array of build steps executed in sequence.</p>
<p>There are many built-in environment variables that are automatically available
to you in your build steps. Many of these have been adapted from other compiled
package managers such as OPAM or Cargo. They are detailed in the <a href="https://github.com/jordwalke/PackageJsonForCompilers">PJC</a> spec
which <code>esy</code> attempts to adhere to.</p>
<p>For example, the environment variable <code>$cur__target_dir</code> points to the location where <code>esy</code> expects to find your build artifacts. <code>$cur__install</code> represents a directory that you are
expected to install your final artifacts into.</p>
<p>A typical configuration might build the artifacts into the special build
destination, and then copy the important artifacts into the final installation
location (which is the cache).</p>
<h2><a class="anchor" aria-hidden="true" id="directory-layout"></a><a href="#directory-layout" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Directory Layout</h2>
<p>Here's a general overview of the directory layout created by various <code>esy</code>
commands.</p>
<h3><a class="anchor" aria-hidden="true" id="global-cache"></a><a href="#global-cache" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Global Cache</h3>
<p>When building projects, most globally cached artifacts are stored in <code>~/.esy</code>.</p>
<pre><code class="hljs">~/.esy/
 ├─ OtherStuffHereToo.md
 └─ 3___long_enough_padding_for_relocating_binaries___/
    ├── b # build dir
    ├── i # installation dir
    └── s # staging dir
</code></pre>
<p>The global store's <code>_build</code> directory contains the logs for each package build (whether it was successful or not). The <code>_install</code> contains the final
compilation artifacts that should be retained.</p>
<h3><a class="anchor" aria-hidden="true" id="top-level-project-build-artifacts"></a><a href="#top-level-project-build-artifacts" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Top Level Project Build Artifacts</h3>
<p>Not all artifacts are cached globally. Build artifacts for any symlinked
dependencies (using <code>yarn link</code>) are stored in
<code>./node_modules/.cache/_esy/store</code> which is just like the global store, but for
your locally symlinked projects, and top level package.</p>
<p>This local cache doesn't have the dirtyling logic as the global store for
(non-symlinked) dependencies. Currently, both symlinked dependencies and your
top level package are both rebuilt every time you run <code>esy build</code>.</p>
<p>Your top level package is build within its source tree, not in a copy of the
source tree, but as always your package can (and should try to) respect the out
of source destination <code>$cur__target_dir</code>.</p>
<p>Cached environment computations (for commands such as <code>esy cmd</code>) are stored in
<code>./node_modules/.cache/_esy/bin/command-env</code></p>
<p>A convenience executable that runs arbitrary commands within the <code>command-env</code>
is stored at <code>./node_modules/.cache/_esy/bin/command-exec</code>.</p>
<p>Support for &quot;ejecting&quot; a build is computed and stored in
<code>./node_modules/.cache/_esy/build-eject</code>.</p>
<pre><code class="hljs">./node_modules/
 └─ .cache/
    └─ _esy/
       ├─ bin/
       │  ├─ build-env
       │  └─ command-env
       ├─ build-eject/
       │  ├─ Makefile
       │  ├─ ...
       │  ├─ eject-env
       │  └─ node_modules   # Perfect mirror
       │     └─ FlappyBird
       │        ├─ ...
       │        └─ eject-env
       └─ store/
          ├── ThisIsBuildCacheForSymlinked
          ├── b
          ├── i
          └── s
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="advanced-build-environment"></a><a href="#advanced-build-environment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Advanced Build Environment</h3>
<p>The following environment variables are related to the package that is
currently being built, which might be <em>different</em> than the package that
owns the package.json where these variables occur. This is because
when building a package, the build environment is computed by traversing
its dependencies and aggregating exported environment variables transitively,
which may refer to the &quot;cur&quot; package - the package <em>cur</em>ently being built.</p>
<ul>
<li><code>$cur__install</code></li>
<li><code>$cur__target_dir</code></li>
<li><code>$cur__root</code></li>
<li><code>$cur__name</code></li>
<li><code>$cur__version</code></li>
<li><code>$cur__depends</code></li>
<li><code>$cur__bin</code></li>
<li><code>$cur__sbin</code></li>
<li><code>$cur__lib</code></li>
<li><code>$cur__man</code></li>
<li><code>$cur__doc</code></li>
<li><code>$cur__stublibs</code></li>
<li><code>$cur__toplevel</code></li>
<li><code>$cur__share</code></li>
<li><code>$cur__etc</code></li>
</ul>
<p>This is based on <a href="https://github.com/jordwalke/PackageJsonForCompilers">PJC</a> spec.</p>
<h3><a class="anchor" aria-hidden="true" id="integration-with-opam-packages-repository"></a><a href="#integration-with-opam-packages-repository" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Integration with OPAM packages repository</h3>
<h4><a class="anchor" aria-hidden="true" id="consuming-published-opam-packages"></a><a href="#consuming-published-opam-packages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Consuming published OPAM packages</h4>
<p>During <code>esy install</code> command running Esy resolves dependencies within the
<code>@opam/*</code> npm scope using a special resolver which looks for a package in the
OPAM repository.</p>
<p>It converts OPAM package metadata into <code>package.json</code> with <code>esy</code> config section
inferred and installs the OPAM package like any regular package inside the
project's <code>node_modules</code> directory.</p>
<p>For example, after running the following command:</p>
<pre><code class="hljs css languages- bash">esy add @opam/lwt
</code></pre>
<p>You can inspect <code>node_modules/@opam/lwt/package.json</code> for Esy build configuration.</p>
<h4><a class="anchor" aria-hidden="true" id="converting-opam-packages-manually"></a><a href="#converting-opam-packages-manually" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Converting OPAM packages manually</h4>
<p>Esy provides a command <code>esy import-opam</code> which can be used like this to convert
OPAM packages manually into <code>package.json</code>-based packages. For example to
convert an lwt package from a repo:</p>
<pre><code class="hljs css languages- bash">git <span class="hljs-built_in">clone</span> https://github.com/ocsigen/lwt
<span class="hljs-built_in">cd</span> lwt
esy import-opam lwt 3.1.0 ./opam &gt; package.json
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="implementation-notes"></a><a href="#implementation-notes" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Implementation notes</h4>
<p>Code for <code>esy install</code> command (along with <code>esy add</code> and <code>esy install-cache</code>
commands) is based on a fork of yarn — <a href="https://github.com/esy/esy-install">esy-ocaml/esy-install</a>.</p>
<p>OPAM to <code>package.json</code> metadata convertation is handled by
<a href="https://github.com/esy-ocaml/esy-opam">esy-ocaml/esy-opam</a>.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/en/release.html">← Building Releases</a><a class="docs-next button" href="/docs/en/development.html">Development →</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#build-steps">Build Steps</a></li><li><a href="#directory-layout">Directory Layout</a><ul class="toc-headings"><li><a href="#global-cache">Global Cache</a></li><li><a href="#top-level-project-build-artifacts">Top Level Project Build Artifacts</a></li><li><a href="#advanced-build-environment">Advanced Build Environment</a></li><li><a href="#integration-with-opam-packages-repository">Integration with OPAM packages repository</a></li></ul></li></ul></nav></div><span><script src="/js/redirectBlog.js"></script><script src="/js/pjax-api.js"></script><script>window.foo = new Pjax({
          areas: [
            // try to use the first query.
            '.mainContainer, .docsNavContainer .toc .navWrapper',
            // fallback
            'body'
          ],
          link: '.docsNavContainer:not(.docsSliderActive) a',
          update: {
            script: false,
          }
        });
        var languagesMenuItemCopy = document.getElementById("languages-menu");
        languagesMenuItemCopy.addEventListener("click", function(e){
          e.preventDefault();
          e.stopPropagation();
          e.stopImmediatePropagation();
        });</script></span></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
              var search = docsearch({
                
                apiKey: 'a7cfb79b829d08c14bd06ae075f9baac',
                indexName: 'esy',
                inputSelector: '#search_input_react'
              });
            </script></body></html>